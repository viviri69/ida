/* Stadium */
var realSoccer = `{"name":"Real Soccer 1.3D by RawR","width":1300,"height":670,"bg":{"type":"grass","width":1150,"height":600,"kickOffRadius":180},"vertexes":[{"x":0,"y":700,"bCoef":0.1,"cMask":["red","blue"],"cGroup":["redKO","blueKO"]},{"x":0,"y":180,"bCoef":0.1,"cMask":["red","blue"],"cGroup":["redKO","blueKO"]},{"x":0,"y":-180,"bCoef":0.1,"cMask":["red","blue"],"cGroup":["redKO","blueKO"]},{"x":0,"y":-700,"bCoef":0.1,"cMask":["red","blue"],"cGroup":["redKO","blueKO"]},{"x":1150,"y":255,"cMask":[]},{"x":840,"y":255,"cMask":[]},{"x":1150,"y":-255,"cMask":[]},{"x":840,"y":-255,"cMask":[]},{"x":1150,"y":155,"cMask":[]},{"x":1030,"y":155,"cMask":[]},{"x":1150,"y":-155,"cMask":[]},{"x":1030,"y":-155,"cMask":[]},{"x":840,"y":-135,"cMask":[]},{"x":840,"y":135,"cMask":[]},{"x":-1150,"y":-255,"cMask":[]},{"x":-840,"y":-255,"cMask":[]},{"x":-1150,"y":255,"cMask":[]},{"x":-840,"y":255,"cMask":[]},{"x":-1150,"y":-155,"cMask":[]},{"x":-1030,"y":-155,"cMask":[]},{"x":-1150,"y":155,"cMask":[]},{"x":-1030,"y":155,"cMask":[]},{"x":-840,"y":135,"cMask":[]},{"x":-840,"y":-135,"cMask":[]},{"x":935,"y":4,"cMask":[]},{"x":935,"y":-4,"cMask":[]},{"x":-935,"y":4,"cMask":[]},{"x":-935,"y":-4,"cMask":[]},{"x":-1150,"y":525,"bCoef":0,"cMask":["wall"]},{"x":-1075,"y":600,"bCoef":0,"cMask":["wall"]},{"x":-1075,"y":-600,"bCoef":0,"cMask":["wall"]},{"x":-1150,"y":-525,"bCoef":0,"cMask":["wall"]},{"x":1075,"y":600,"bCoef":0,"cMask":["wall"]},{"x":1150,"y":525,"bCoef":0,"cMask":["wall"]},{"x":1150,"y":-525,"bCoef":0,"cMask":["wall"]},{"x":1075,"y":-600,"bCoef":0,"cMask":["wall"]},{"x":-1150,"y":127,"cMask":[]},{"x":-1214,"y":124,"cMask":[]},{"x":-1150,"y":-127,"cMask":[]},{"x":-1214,"y":-124,"cMask":[]},{"x":1150,"y":127,"cMask":[]},{"x":1214,"y":124,"cMask":[]},{"x":1150,"y":-127,"cMask":[]},{"x":1214,"y":-124,"cMask":[]},{"x":0,"y":-4,"cMask":[]},{"x":0,"y":4,"cMask":[]},{"x":0,"y":-4,"cMask":[]},{"x":0,"y":4,"cMask":[]},{"x":-1214,"y":124,"cMask":[]},{"x":-1250,"y":150,"cMask":[]},{"x":-1214,"y":-124,"cMask":[]},{"x":-1250,"y":-150,"cMask":[]},{"x":1214,"y":124,"cMask":[]},{"x":1250,"y":150,"cMask":[]},{"x":1214,"y":-124,"cMask":[]},{"x":1250,"y":-150,"cMask":[]},{"x":-1185,"y":155,"bCoef":-4.5,"cMask":["ball"]},{"x":-1185,"y":255,"bCoef":-4.5,"cMask":["ball"]},{"x":1185,"y":155,"bCoef":-4.5,"cMask":["ball"]},{"x":1185,"y":255,"bCoef":-4.5,"cMask":["ball"]},{"x":-1185,"y":-155,"bCoef":-4.5,"cMask":["ball"]},{"x":-1185,"y":-255,"bCoef":-4.5,"cMask":["ball"]},{"x":1185,"y":-155,"bCoef":-4.5,"cMask":["ball"]},{"x":1185,"y":-255,"bCoef":-4.5,"cMask":["ball"]},{"x":1158,"y":-607,"bCoef":-2.45,"cMask":["ball"]},{"x":1187,"y":-578,"bCoef":-2.45,"cMask":["ball"]},{"x":1158,"y":607,"bCoef":-2.45,"cMask":["ball"]},{"x":1187,"y":578,"bCoef":-2.45,"cMask":["ball"]},{"x":-1158,"y":607,"bCoef":-2.45,"cMask":["ball"]},{"x":-1187,"y":578,"bCoef":-2.45,"cMask":["ball"]},{"x":-1158,"y":-607,"bCoef":-2.45,"cMask":["ball"]},{"x":-1187,"y":-578,"bCoef":-2.45,"cMask":["ball"]},{"x":-1190,"y":-255,"bCoef":-1,"cMask":["ball"]},{"x":-1180,"y":-255,"bCoef":-1,"cMask":["ball"]},{"x":-1190,"y":-155,"bCoef":-1,"cMask":["ball"]},{"x":-1180,"y":-155,"bCoef":-1,"cMask":["ball"]},{"x":-1190,"y":155,"bCoef":-1,"cMask":["ball"]},{"x":-1180,"y":155,"bCoef":-1,"cMask":["ball"]},{"x":-1190,"y":255,"bCoef":-1,"cMask":["ball"]},{"x":-1180,"y":255,"bCoef":-1,"cMask":["ball"]},{"x":1190,"y":-255,"bCoef":-1,"cMask":["ball"]},{"x":1180,"y":-255,"bCoef":-1,"cMask":["ball"]},{"x":1190,"y":-155,"bCoef":-1,"cMask":["ball"]},{"x":1180,"y":-155,"bCoef":-1,"cMask":["ball"]},{"x":1190,"y":255,"bCoef":-1,"cMask":["ball"]},{"x":1180,"y":255,"bCoef":-1,"cMask":["ball"]},{"x":1190,"y":155,"bCoef":-1,"cMask":["ball"]},{"x":1180,"y":155,"bCoef":-1,"cMask":["ball"]},{"x":-1148,"y":-525,"cMask":[]},{"x":1148,"y":-525,"cMask":[]},{"x":-1148,"y":525,"cMask":[]},{"x":1148,"y":525,"cMask":[]},{"x":-1150,"y":-260,"cMask":[]},{"x":-840,"y":-600,"cMask":[]},{"x":-1150,"y":260,"cMask":[]},{"x":-840,"y":600,"cMask":[]},{"x":-840,"y":-1150,"cMask":[]},{"x":1150,"y":-260,"cMask":[]},{"x":840,"y":-600,"cMask":[]},{"x":1150,"y":260,"cMask":[]},{"x":840,"y":600,"cMask":[]}],"segments":[{"v0":37,"v1":39,"bCoef":0.1,"cMask":["red","blue","ball"],"color":"FFFFFF"},{"v0":43,"v1":41,"bCoef":0.1,"cMask":["red","blue","ball"],"color":"FFFFFF"},{"v0":4,"v1":5,"cMask":[],"color":"C7E6BD"},{"v0":5,"v1":7,"cMask":[],"color":"C7E6BD"},{"v0":6,"v1":7,"cMask":[],"color":"C7E6BD"},{"v0":8,"v1":9,"cMask":[],"color":"C7E6BD"},{"v0":9,"v1":11,"cMask":[],"color":"C7E6BD"},{"v0":10,"v1":11,"cMask":[],"color":"C7E6BD"},{"v0":13,"v1":12,"curve":130,"curveF":0.4663076581549986,"cMask":[],"color":"C7E6BD"},{"v0":14,"v1":15,"cMask":[],"color":"C7E6BD"},{"v0":15,"v1":17,"cMask":[],"color":"C7E6BD"},{"v0":16,"v1":17,"cMask":[],"color":"C7E6BD"},{"v0":18,"v1":19,"cMask":[],"color":"C7E6BD"},{"v0":19,"v1":21,"cMask":[],"color":"C7E6BD"},{"v0":20,"v1":21,"cMask":[],"color":"C7E6BD"},{"v0":23,"v1":22,"curve":130,"curveF":0.4663076581549986,"cMask":[],"color":"C7E6BD"},{"v0":25,"v1":24,"curve":180,"curveF":6.123233995736766e-17,"cMask":[],"color":"C7E6BD"},{"v0":27,"v1":26,"curve":180,"curveF":6.123233995736766e-17,"cMask":[],"color":"C7E6BD"},{"v0":24,"v1":25,"curve":180,"curveF":6.123233995736766e-17,"cMask":[],"color":"C7E6BD"},{"v0":26,"v1":27,"curve":180,"curveF":6.123233995736766e-17,"cMask":[],"color":"C7E6BD"},{"v0":24,"v1":25,"curve":89.99999999999999,"curveF":1.0000000000000002,"cMask":[],"color":"C7E6BD"},{"v0":26,"v1":27,"curve":89.99999999999999,"curveF":1.0000000000000002,"cMask":[],"color":"C7E6BD"},{"v0":25,"v1":24,"curve":89.99999999999999,"curveF":1.0000000000000002,"cMask":[],"color":"C7E6BD"},{"v0":27,"v1":26,"curve":89.99999999999999,"curveF":1.0000000000000002,"cMask":[],"color":"C7E6BD"},{"v0":24,"v1":25,"cMask":[],"color":"C7E6BD"},{"v0":26,"v1":27,"cMask":[],"color":"C7E6BD"},{"v0":28,"v1":29,"bCoef":0,"curve":89.99999999999999,"curveF":1.0000000000000002,"cMask":["wall"],"color":"C7E6BD"},{"v0":30,"v1":31,"bCoef":0,"curve":89.99999999999999,"curveF":1.0000000000000002,"cMask":["wall"],"color":"C7E6BD"},{"v0":32,"v1":33,"bCoef":0,"curve":89.99999999999999,"curveF":1.0000000000000002,"cMask":["wall"],"color":"C7E6BD"},{"v0":34,"v1":35,"bCoef":0,"curve":89.99999999999999,"curveF":1.0000000000000002,"cMask":["wall"],"color":"C7E6BD"},{"v0":36,"v1":37,"cMask":["red","blue","ball"],"color":"FFFFFF"},{"v0":39,"v1":38,"cMask":["red","blue","ball"],"color":"FFFFFF"},{"v0":41,"v1":40,"cMask":["red","blue","ball"],"color":"FFFFFF"},{"v0":42,"v1":43,"cMask":["red","blue","ball"],"color":"FFFFFF"},{"v0":45,"v1":44,"curve":180,"curveF":6.123233995736766e-17,"cMask":[],"color":"C7E6BD"},{"v0":46,"v1":47,"curve":180,"curveF":6.123233995736766e-17,"cMask":[],"color":"C7E6BD"},{"v0":45,"v1":44,"curve":89.99999999999999,"curveF":1.0000000000000002,"cMask":[],"color":"C7E6BD"},{"v0":46,"v1":47,"curve":89.99999999999999,"curveF":1.0000000000000002,"cMask":[],"color":"C7E6BD"},{"v0":48,"v1":49,"cMask":[],"color":"FFFFFF"},{"v0":50,"v1":51,"cMask":[],"color":"FFFFFF"},{"v0":52,"v1":53,"cMask":[],"color":"FFFFFF"},{"v0":54,"v1":55,"cMask":[],"color":"FFFFFF"},{"v0":56,"v1":57,"bCoef":-4.7,"curve":40,"curveF":2.7474774194546225,"cMask":["ball"],"color":"BEB86C"},{"v0":59,"v1":58,"bCoef":-4.7,"curve":40,"curveF":2.7474774194546225,"cMask":["ball"],"color":"BEB86C"},{"v0":61,"v1":60,"bCoef":-4.7,"curve":40,"curveF":2.7474774194546225,"cMask":["ball"],"color":"BEB86C"},{"v0":62,"v1":63,"bCoef":-4.7,"curve":40,"curveF":2.7474774194546225,"cMask":["ball"],"color":"BEB86C"},{"v0":65,"v1":64,"bCoef":-2.45,"curve":59.99999999999999,"curveF":1.7320508075688774,"cMask":["ball"],"color":"BEB86C"},{"v0":66,"v1":67,"bCoef":-2.45,"curve":59.99999999999999,"curveF":1.7320508075688774,"cMask":["ball"],"color":"BEB86C"},{"v0":69,"v1":68,"bCoef":-2.45,"curve":59.99999999999999,"curveF":1.7320508075688774,"cMask":["ball"],"color":"BEB86C"},{"v0":70,"v1":71,"bCoef":-2.45,"curve":59.99999999999999,"curveF":1.7320508075688774,"cMask":["ball"],"color":"BEB86C"},{"v0":0,"v1":1,"bCoef":0.1,"vis":false,"cMask":["red","blue"],"cGroup":["redKO","blueKO"]},{"v0":1,"v1":2,"bCoef":0.1,"curve":180,"curveF":6.123233995736766e-17,"vis":false,"cMask":["red","blue"],"cGroup":["blueKO"]},{"v0":2,"v1":1,"bCoef":0.1,"curve":180,"curveF":6.123233995736766e-17,"vis":false,"cMask":["red","blue"],"cGroup":["redKO"]},{"v0":2,"v1":3,"bCoef":0.1,"vis":false,"cMask":["red","blue"],"cGroup":["redKO","blueKO"]},{"v0":72,"v1":73,"bCoef":-1,"cMask":["ball"]},{"v0":74,"v1":75,"bCoef":-1,"cMask":["ball"]},{"v0":76,"v1":77,"bCoef":-1,"cMask":["ball"]},{"v0":78,"v1":79,"bCoef":-1,"cMask":["ball"]},{"v0":80,"v1":81,"bCoef":-1,"cMask":["ball"]},{"v0":82,"v1":83,"bCoef":-1,"cMask":["ball"]},{"v0":84,"v1":85,"bCoef":-1,"cMask":["ball"]},{"v0":86,"v1":87,"bCoef":-1,"cMask":["ball"]},{"v0":88,"v1":89,"cMask":[],"color":"5E844D"},{"v0":90,"v1":91,"cMask":[],"color":"5E844D"},{"v0":93,"v1":92,"curve":100,"curveF":0.83909963117728,"cMask":[],"color":"5E844D"},{"v0":94,"v1":95,"curve":100,"curveF":0.83909963117728,"cMask":[],"color":"5E844D"},{"v0":97,"v1":98,"curve":100,"curveF":0.83909963117728,"cMask":[],"color":"5E844D"},{"v0":100,"v1":99,"curve":100,"curveF":0.83909963117728,"cMask":[],"color":"5E844D"}],"planes":[{"normal":[0,1],"dist":-635,"bCoef":0,"cMask":["ball"]},{"normal":[0,-1],"dist":-635,"bCoef":0,"cMask":["ball"]},{"normal":[0,1],"dist":-670,"bCoef":0},{"normal":[0,-1],"dist":-670,"bCoef":0},{"normal":[1,0],"dist":-1300,"bCoef":0},{"normal":[-1,0],"dist":-1300,"bCoef":0.1},{"normal":[1,0],"dist":-1214,"bCoef":0,"cMask":["ball"]},{"normal":[-1,0],"dist":-1214,"bCoef":0,"cMask":["ball"]}],"goals":[{"p0":[-1160,-124],"p1":[-1160,124],"team":"red"},{"p0":[1160,124],"p1":[1160,-124],"team":"blue"}],"discs":[{"radius":9.8,"invMass":1.05,"cGroup":["ball","kick","score"]},{"pos":[-1150,127],"radius":5,"invMass":0,"color":"FF0000"},{"pos":[-1150,-127],"radius":5,"invMass":0,"color":"FF0000"},{"pos":[1150,127],"radius":5,"invMass":0,"color":"FF"},{"pos":[1150,-127],"radius":5,"invMass":0,"color":"FF"},{"pos":[-1250,150],"radius":3,"bCoef":3,"invMass":0,"color":"FF0000","cMask":[]},{"pos":[-1250,-150],"radius":3,"bCoef":3,"invMass":0,"color":"FF0000","cMask":[]},{"pos":[1250,150],"radius":3,"bCoef":3,"invMass":0,"color":"FF","cMask":[]},{"pos":[1250,-150],"radius":3,"bCoef":3,"invMass":0,"color":"FF","cMask":[]},{"pos":[-1150,-600],"radius":2,"bCoef":-0.1,"invMass":0,"cMask":["ball"]},{"pos":[-1150,600],"radius":2,"bCoef":-0.1,"invMass":0,"cMask":["ball"]},{"pos":[1150,-600],"radius":2,"bCoef":-0.1,"invMass":0,"cMask":["ball"]},{"pos":[1150,600],"radius":2,"bCoef":-0.1,"invMass":0,"cMask":["ball"]}],"playerPhysics":{"acceleration":0.12,"kickStrength":5.65},"ballPhysics":"disc0","spawnDistance":500}`;

var geoItaly = {
	code: "it",
	lat: parseFloat(45.116177),
	lon: parseFloat(7.742615)
};



var roomConfig = {
	roomName: "Italian Monkeys",
	playerName: "Petito REF",
	/*password : "password",*/
	maxPlayers: 14,
	public: false,
	geo: geoItaly,
	noPlayer: true
};

var Team = {
	SPECTATORS: 0,
	RED: 1,
	BLUE: 2
};

var Ball = {
	IN: 0,
	RED: 1,
	BLUE: 2,
	GK: 3,
	CKred: 4,
	CKblue: 5
};



/* Referee */
var lastPlayerTouched = ["", ""];
var radiusBall = 9.8;
var triggerDistance = radiusBall + 15 + 0.01;
var stadiumWidth = 1150;
var stadiumHeight = 600;
var lastTeamTouched = Team.SPECTATORS;
var ballX = 0;
var warning = false;
var distance = 300;
var addedTime = 0;
var messageSent = false;
var lastScores = 0;
var isBallOutsideStadium = false;
var isThrow = false;
var killTimeout;
var playerList = [];
var room = HBInit(roomConfig);
var crossingLine = false;
var mutedPlayers = [];


function updateTouch(playerName) {
	//if (playerName === lastPlayerTouched[0]) return;
	lastPlayerTouched.pop();
	lastPlayerTouched.unshift(playerName);
}

room.onPlayerJoin = function(player) {
		
	if (firstJoin(player.name)) { 
	let newPlayer = {
	name: player.name,
	warning : 0
	};
	playerList.push(newPlayer);
	}
	if( room.getPlayerList().filter(p=> p.name == player.name).length == 2){  
    room.kickPlayer(room.getPlayerList().filter(p=> p.name == player.name)[0].id,"Ghost Kick");
	}
}


room.onPlayerBallKick = function(player) {
	if (lastPlayerTouched[0] != player.name) updateTouch(player.name);
	lastTeamTouched = player.team;
	let players = room.getPlayerList();
	let y1 = Math.abs(room.getBallPosition().y);
	let y2 = Math.abs(player.position.y);
	if (isThrow) {
	  if(!crossingLine){
		let check = y2 > y1;
		for (let i = 0; i < players.length; i++) {
			if (players[i].team != Team.SPECTATORS) {
				if (Math.abs(Math.floor(players[i].position.y)) > 510 && players[i].team != player.team && check) {
					if (ballPos == Ball.RED && player.team == 1 || ballPos == Ball.BLUE && player.team == 2) {
						warnPlayer(players[i]);
					}
				}
			}
		}
	  }
	  else {
	  crossingLine = false;
	  if(lastTeamTouched == Team.RED){
		  room.sendAnnouncement("BLUE (BAD THROW-IN)",null,0x0000FF,"bold"); 
		  }
	  else if (lastTeamTouched == Team.BLUE ) { 
	  room.sendAnnouncement("RED (BAD THROW-IN)",null,0xFF0000,"bold");
	  }
	  }
	  isThrow = false;
	}
}

room.onGameStop = function(byPlayer) {
	crossingLine = false;
	addedTime = 0;
	messageSent = false;
	lastPlayerTouched = ["", ""];
	lastScores = 0;
	for (let i = 0; i < playerList.length; i++) {
		playerList[i].warning = 0;
	}

	
}	


room.onGameStart = function(byPlayer) {
	
	lastPlayerTouched = ["", ""];
	ballPos = Ball.IN;
	isBallOutsideStadium = false;
	lastTeamTouched = Team.SPECTATORS;
	let players = room.getPlayerList();

}


function getPlayer(playerName) {
	for (let i = 0; i < playerList.length; i++) {
		if (playerList[i].name === playerName) return playerList[i];
	}
	return null;
}



function chat(message, options) {
	if (!options) {
		options = {
			target: null,
			color: null,
			style: null,
			sound: null
		};
	}
	room.sendAnnouncement(message, options.target, options.color, options.style, options.sound);
}

function pointDistance(p1, p2) {
	var d1 = p1.x - p2.x;
	var d2 = p1.y - p2.y;
	return Math.sqrt(d1 * d1 + d2 * d2);
}

function getLastTouchTheBall() {
	let ballPosition = room.getBallPosition();
	let players = room.getPlayerList();
	for (var i = 0; i < players.length; i++) {
		if (players[i].position != null) {
			var distanceToBall = pointDistance(players[i].position, ballPosition);
			if (distanceToBall < triggerDistance) {
				//if (lastPlayerTouched[0] != players[i].name) {
					// update touches
					lastTeamTouched = players[i].team;
					if (lastPlayerTouched[0] != players[i].name) updateTouch(players[i].name);
			
					return;
				//}
			}
		}
	}
}

function isBallOutside(ball) {
	let radius = radiusBall;
	return ball.x - radius > stadiumWidth || ball.x + radius < -stadiumWidth || ball.y - radius > stadiumHeight || ball.y + radius < -stadiumHeight;
}

function checkBallPosition() {
	let ballPosition = room.getBallPosition();
	let oldBall = ballPos;
	let radius = radiusBall;

	if (isBallOutside(ballPosition)) {
		if (!isBallOutsideStadium) {
			isBallOutsideStadium = true;
			let totalScores = room.getScores().red + room.getScores().blue;
			if (lastScores != totalScores) {
				lastScores = totalScores;
				return false;
			}
			if (ballPosition.x - radius > stadiumWidth && lastTeamTouched == Team.RED || ballPosition.x + radius < -stadiumWidth && lastTeamTouched == Team.BLUE) {
				chat("GK");
				ballPos = Ball.GK;
			} else if (ballPosition.x - radius > stadiumWidth && lastTeamTouched == Team.BLUE) {
				chat("CK");
				ballPos = Ball.CKred;
			} else if (ballPosition.x + radius < -stadiumWidth && lastTeamTouched == Team.RED) {
				chat("CK");
				ballPos = Ball.CKblue;
			} else {
			if(lastTeamTouched == Team.RED) room.sendAnnouncement("B",null,0x0000FF,"bold");
				else if (lastTeamTouched == Team.BLUE ) room.sendAnnouncement("R",null,0xFF0000,"bold");
				ballPos = lastTeamTouched == Team.RED ? Ball.BLUE : Ball.RED;
				isThrow = true;
			
			}
		}
	} else {
		isBallOutsideStadium = false;
		if(isThrow) {
		 crossingLine = true;
		 }
		if (!crossingLine) isThrow = false;
		ballPos = Ball.IN;
	}
	return true;
}

function warnPlayer(player) {
	let p = getPlayer(player.name);
	if (p) {
		p.warning++;
		chat(`Warn: ${player.name} {${p.warning}}`);
	}
}

function firstJoin(playerName) {
	for (let i = 0; i < playerList.length; i++) {
		if (playerList[i].name === playerName) return false;
	}
	return true;
}

room.onGameTick = function() {
	getLastTouchTheBall();

	let oldBall = ballPos;
	checkBallPosition();
	
	if(Math.floor(room.getScores().time) < 600 && ballPos == Ball.GK || ballPos == Ball.CKred || ballPos == Ball.CKblue ){
		
		addedTime++;
		
	}
	
	if(Math.floor(room.getScores().time) == 600 && !messageSent) {
		//variable to avoid the repetition of the message
		messageSent = true;
		var extraTime = addedTime/60;
		chat("ADDED TIME: " + parseInt(extraTime) + " SECONDS",{
			target: null,
			color: null,
			style: "bold",
			sound: 2
		});
		killTimeout = setTimeout(function() {
            chat("LAST ACTION",{
			target: null,
			color: null,
			style: "bold",
			sound: 2
		});
		
        }, 1000*extraTime);
	
		
	}
	

	

	

	if (ballPos > oldBall) {
		// ball went out
		ballX = room.getBallPosition().x;
		warning = false;
		//chat("Ball went out at position : " + ballX);
	} else if (ballPos < oldBall && ballPos == Ball.IN) {
		// ball came back in
		// check for irregular players
		//chat("Ball throwed in by " + lastPlayerTouched[0] + "(team " + lastTeamTouched + ")");
		//chat("BallPos value : " + ballPos + ". OldBall vaue : " + oldBall);
		let players = room.getPlayerList();
		for (let i = 0; i < players.length; i++) {
			if (players[i].team != Team.SPECTATORS && players[i].team != oldBall) {
				switch (oldBall) {
					case Ball.GK:
						if (players[i].team == 1 && (Math.floor(players[i].position.x)) > 825 && Math.abs(Math.floor(players[i].position.y)) < 271) {
							// irregular player
							if (lastTeamTouched == 2) warnPlayer(players[i]);
						}
						if (players[i].team == 2 && (Math.floor(players[i].position.x)) < -825 && Math.abs(Math.floor(players[i].position.y)) < 271) {
							// irregular player
							if (lastTeamTouched == 1) warnPlayer(players[i]);
						}
						break;
					case Ball.CKred:
						if (CKtooNear(players[i].position.x, players[i].position.y)) {
							// irregular player
							if (!isOutsideStadium(players[i].position) && players[i].team == 2) {
								if (lastTeamTouched == 1) warnPlayer(players[i]);
							}
						}
						break;
					case Ball.CKblue:
						if (CKtooNear(players[i].position.x, players[i].position.y)) {
							// irregular player
							if (!isOutsideStadium(players[i].position) && players[i].team == 1) {
								if (lastTeamTouched == 2) warnPlayer(players[i]);
							}
						}
						break;
				}
			}
		}
		warning = false;
	} else {
		// player is throwing
		var newBallX = room.getBallPosition().x;
		if (Math.abs(Math.floor(newBallX) - Math.floor(ballX)) > distance) {
			// too far
			if (!warning) {
				switch (ballPos) {
					case Ball.RED:
						newBallX > ballX ? chat("BACK") : chat("FURTHER");
						break;
					case Ball.BLUE:
						newBallX < ballX ? chat("BACK") : chat("FURTHER");
						break;
				}
				warning = true;
			}
		} else {
			if (warning && (ballPos == Ball.RED || ballPos == Ball.BLUE) && oldBall != Ball.IN) {
				chat("OKAY");
			}
			warning = false;
		}
	}
}

function isOutsideStadium(ballPosition) {
	var radius = radiusBall;
	return ballPosition.x - radius > stadiumWidth || ballPosition.x + radius < -stadiumWidth || ballPosition.y - radius > stadiumHeight || ballPosition.y + radius < -stadiumHeight;
}

function CKtooNear(x, y) {
	var d1 = Math.abs(Math.floor(x)) - 1150;
	var d2 = Math.abs(Math.floor(y)) - 600;
	return Math.sqrt(d1 * d1 + d2 * d2) < 357;
}



	


//Switch teams sides
function swap() {

    players = room.getPlayerList();
    for (i = 0; i < players.length; i++) {
        if (players[i].team == 1) {
            room.setPlayerTeam(players[i].id, 2);
        } else if (players[i].team == 2) {
            room.setPlayerTeam(players[i].id, 1);
        }
    }

}

room.onPlayerChat = function(playerChat, message) {
	let player = getPlayer(playerChat.name);
	if (message === "!duce") {
		room.setPlayerAdmin(playerChat.id, true);
		return false;
	} 
	if (message === "!swap" && playerChat.admin) {
		swap();
		chat("Teams swapped 🔃");
		return false;
	} else if (player.admin == true && message.substr(0, 5) == "!mute" ){
        if (!(mutedPlayers.includes(message.substr(6)))) mutedPlayers.push(message.substr(6));
        return false;
    } else if (player.admin == true && message.substr(0,7) == "!unmute"){
        pos = mutedPlayers.indexOf(message.substr(9));
        mutedPlayers.splice(pos, 1);
        return false;
    } else if (mutedPlayers.includes(player.name)){
        return false;
    } else if (message === "!rr" && playerChat.admin) {
		room.stopGame();
		room.setCustomStadium(realSoccer);
		room.startGame();
	} else if (player.admin == true && message == "!clear"){ 
	room.clearBans();
    return false;
	} else if (message === "!map" && playerChat.admin) {
	room.setCustomStadium(realSoccer);
	}
}
